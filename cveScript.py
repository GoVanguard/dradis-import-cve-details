import json
from json import dumps
import requests
from requests import Session
from sys import argv, exit, version
from argparse import ArgumentParser
from time import sleep
import re

class cveScript(object):
    def __init__(self):
        self.arg = self.parse_args()
        if len(argv) != 4:
            print("wrong argument amount. see HELP")
            exit(-6)
        self._headers = {}
        self.title_column = 0      # 'title' column  in csv required for all exports
        self.node_name_column = 0  # 'node_name' column in csv required for both nodes exports
        self.issue_id_column = 0   # 'issue_id' column in csv required for nodes w/evidence exports
        # Dradis API Configuration
        self.verify_cert = True    # change this to make requests without verifying
        self.dradis_api_token = self.arg.dradis_api_token
        self.dradis_project_id = self.arg.dradis_project_id
        self.dradis_url = self.arg.dradis_url
        self.dradis_issues_url = '{0}/pro/api/issues/'.format(self.dradis_url)
        self.dradis_nodes_url = '{0}/pro/api/nodes/'.format(self.dradis_url)
        self.session = Session()
        self.session.headers.update({'Authorization': 'Token token="{0}"'.format(self.dradis_api_token)})
        self.session.headers.update({'Dradis-Project-Id': self.dradis_project_id})
        self.session.headers.update({'Content-type': 'application/json'})
    
    def run(self):
        try:
            self.appendCveNum()
        except Exception as e:
            print('Failed in run: {0}'.format(e))
            exit(-1)
        self.session.close()
        return 0

    def appendCvss(self, newCveSite, issuetitle):
        issue_title = issuetitle
        cvss = ''
        cvssFieldPattern = re.compile(r'CVSS Score</th><td><div class="cvssbox" style="background-color:#')
        cvssPattern1 = re.compile(r'[0-9].[0-9]')
        cvssPattern2 = re.compile(r'[0-1][0-9].[0-9]')
        # Getting CVSS from cvedetails website via generic HTTP GET request
        cvssReq = requests.get(newCveSite)

        # Converting response body into a string
        responseBody = str(cvssReq.text)

        # Searching response body (string version) to see if it has a CVSS score
        fieldMatch = re.search(cvssFieldPattern, responseBody)
        if fieldMatch:
            a = fieldMatch.end() + 7
            match1 = re.search(cvssPattern1, fieldMatch.string())
            match2 = re.search(cvssPattern2, fieldMatch.string())
            if match1:
                e = a + 2
                cvss = match1.string[a:e]
            elif match2:
                e = a + 3
                cvss = match2.string[a:e]
            else:
                cvss = "N/A"
        else:
            print("\nAppend CVSS method is done fucked according to " + issue_title)

        return cvss

    def appendComplexity(self, newCveSite, issuetitle):
        issue_title = issuetitle
        complexity = ''
        complexityFieldPattern = re.compile(r'Access Complexity')
        complexityLow = re.compile(r'low')
        complexityMed = re.compile(r'medium')
        complexityHigh = re.compile(r'high')

        # Getting Access Complexity field from cvssdetails website via generic HTTP GET request
        req = requests.get(newCveSite)

        # Converting response body into a string
        responseBody = str(req.text)

        # Searching response body (string version)
        fieldMatch = re.search(complexityFieldPattern, responseBody)
        if fieldMatch:
            a = fieldMatch.end()
            match1 = re.search(complexityLow, fieldMatch.string[a:a+48].lower())
            match2 = re.search(complexityMed, fieldMatch.string[a:a+48].lower())
            match3 = re.search(complexityHigh, fieldMatch.string[a:a+48].lower())
            if match1:
                print("\nFound a complexity of Low on cvedetails\n")
                s = a + 4
                e = s + 2
                complexity = "High"
            elif match2:
                print("\nFound a complexity of Medium on cvedetails\n")
                s = a + 7
                e = s + 5
                complexity = "Moderate"
            elif match3:
                print("\nFound a complexity of High on cvedetails\n")
                s = a + 6
                e = s + 3
                complexity = "Low"
            else:
                complexity = "Low"
        else:
            print("\nAppend Complexity method is done fucked according to " + issue_title)

        return complexity

    def appendImpact(self, newCveSite, issuetitle):
        issue_title = issuetitle
        impact = ''
        impactFieldPattern = re.compile(r'Confidentiality Impact')
        impactNone = re.compile(r'none')
        impactPartial = re.compile(r'partial')
        impactComplete = re.compile(r'complete')

        # Getting Access Complexity field from cvssdetails website via generic HTTP GET request
        req = requests.get(newCveSite)

        # Converting response body into a string
        responseBody = str(req.text)

        # Searching response body (string version)
        fieldMatch = re.search(impactFieldPattern, responseBody)
        if fieldMatch:
            z = fieldMatch.start()
            a = fieldMatch.end()
            match1 = re.search(impactNone, fieldMatch.string[a:a+49].lower())
            match2 = re.search(impactPartial, fieldMatch.string[a:a+49].lower())
            match3 = re.search(impactComplete, fieldMatch.string[a:a+49].lower())
            if match1:
                print("\nFound an impact of None on cvedetails\n")
                s = a + 6
                e = s + 3
                impact = "Low"
            elif match2:
                print("\nFound an impact of Partial on cvedetails\n")
                s = a + 7
                e = s + 6
                impact = "Moderate"
            elif match3:
                print("\nFound an impact of Complete on cvedetails\n")
                s = a + 4
                e = s + 7
                impact = "High"
            else:
                impact = "Low"
        else:
            print("\nAppend Impact method is done fucked according to " + issue_title)

        return impact

    def appendIntegrity(self, newCveSite, issuetitle):
        issue_title = issuetitle
        integrity = ''
        integrityFieldPattern = re.compile(r'Integrity Impact')
        integrityNone = re.compile(r'none')
        integrityPartial = re.compile(r'partial')
        integrityComplete = re.compile(r'complete')

        # Getting Integrity Impact field from cvssdetails website via generic HTTP GET request
        req = requests.get(newCveSite)

        # Converting response body into a string
        responseBody = str(req.text)

        # Searching response body (string version)
        fieldMatch = re.search(integrityFieldPattern, responseBody)
        if fieldMatch:
            z = fieldMatch.start()
            a = fieldMatch.end()
            match1 = re.search(integrityNone, fieldMatch.string[a:a+47].lower())
            match2 = re.search(integrityPartial, fieldMatch.string[a:a+47].lower())
            match3 = re.search(integrityComplete, fieldMatch.string[a:a+47].lower())
            if match1:
                print("\nFound an integrity impact of None on cvedetails\n")
                integrity = "None"
            elif match2:
                print("\nFound an integrity impact of Partial on cvedetails\n")
                integrity = "Partial"
            elif match3:
                print("\nFound an integrity impact of Complete on cvedetails\n")
                integrity = "Complete"
            else:
                integrity = "N/A"
        else:
            print("\nAppend Integrity Impact method is done fucked according to " + issue_title)

        return integrity

    def appendAuthentication(self, newCveSite, issuetitle):
        issue_title = issuetitle
        authentication = ''
        authenticationFieldPattern = re.compile(r'Authentication')
        authenticationNotRequired = re.compile(r'not required')
        authenticationRequired = re.compile(r'required')

        # Getting Authentication field from cvssdetails website via generic HTTP GET request
        req = requests.get(newCveSite)

        # Converting response body into a string
        responseBody = str(req.text)

        # Searching response body (string version)
        fieldMatch = re.search(authenticationFieldPattern, responseBody)
        if fieldMatch:
            z = fieldMatch.start()
            a = fieldMatch.end()
            match1 = re.search(authenticationNotRequired, fieldMatch.string[a:a+49].lower())
            match2 = re.search(authenticationRequired, fieldMatch.string[a:a+49].lower())
            if match1:
                print("\nFound an Authentication of Not required on cvedetails\n")
                authentication = "Not required"
            elif match2:
                print("\nFound an Authentication of Required on cvedetails\n")
                authentication = "Required"
            else:
                impact = "Not required"
        else:
            print("\nAppend Authentication method is done fucked according to " + issue_title)

        return authentication

    def appendGainedAccess(self, newCveSite, issuetitle):
        issue_title = issuetitle
        access = ''
        accessFieldPattern = re.compile(r'Gained Access')
        accessNone = re.compile(r'none')
        accessPartial = re.compile(r'partial')
        accessComplete = re.compile(r'complete')

        # Getting Gained Access field from cvssdetails website via generic HTTP GET request
        req = requests.get(newCveSite)

        # Converting response body into a string
        responseBody = str(req.text)

        # Searching response body (string version)
        fieldMatch = re.search(accessFieldPattern, responseBody)
        if fieldMatch:
            z = fieldMatch.start()
            a = fieldMatch.end()
            match1 = re.search(accessNone, fieldMatch.string[a:a+48].lower())
            match2 = re.search(accessPartial, fieldMatch.string[a:a+48].lower())
            match3 = re.search(accessComplete, fieldMatch.string[a:a+48].lower())
            if match1:
                print("\nFound a Gained Access of None on cvedetails\n")
                access = "None"
            elif match2:
                print("\nFound a Gained Access of Partial on cvedetails\n")
                access = "Partial"
            elif match3:
                print("\nFound a Gained Access of Complete on cvedetails\n")
                access = "Complete"
            else:
                access = "N/A"
        else:
            print("\nAppend Gained Access method is done fucked according to " + issue_title)

        return access

    def appendVulnType(self, newCveSite, issuetitle):
        issue_title = issuetitle
        vulnType = ''
        vulnTypeFieldPattern = re.compile(r'Vulnerability Type(s)')
        vulnDOS = re.compile(r'denial of service')
        vulnExecuteCode = re.compile(r'execute code')

        # Getting Vulnerability Type field from cvssdetails website via generic HTTP GET request
        req = requests.get(newCveSite)

        # Converting response body into a string
        responseBody = str(req.text)

        # Searching response body (string version)
        fieldMatch = re.search(vulnTypeFieldPattern, responseBody)
        if fieldMatch:
            z = fieldMatch.start()
            a = fieldMatch.end()
            match1 = re.search(vulnDOS, fieldMatch.string[a:a+50].lower())
            match2 = re.search(vulnExecuteCode, fieldMatch.string[a:a+50].lower())
            if match1:
                print("\nFound a Vulnerability Type of Denial of Service on cvedetails\n")
                vulnType = "Denial of Service"
            elif match2:
                print("\nFound a Vulnerability Type of Execute Code on cvedetails\n")
                vulnType = "Execute Code"
            else:
                access = "N/A"
        else:
            print("\nAppend Vulnerability Type method is done fucked according to " + issue_title)

        return vulnType

    def appendExploitLinks(self, newCveSite, issuetitle):
        issue_title = issuetitle
		exploitLinks = []
        secfocusFieldPattern = re.compile(r'securityfocus.com/bid/')
        exploitdbFieldPattern = re.compile(r'exploit-db.com/exploits/')

        # Getting Exploit Links field from cvssdetails website via generic HTTP GET request
        req = requests.get(newCveSite)

        # Converting response body into a string
        responseBody = str(req.text)

        # Searching response body (string version)
        fieldMatch1 = re.search(secfocusFieldPattern, responseBody)
        fieldMatch2 = re.search(exploitdbFieldPattern, responseBody)
        if fieldMatch1:

        else:
            print("\nFound no securityfocus link in " + issue_title)

        if fieldMatch2:

        else:
            print("\nFound no exploit-db link in " + issue_title)

    def calculateRisk(self, imp, ez):
        impact = imp
        ease = ez
        risk = ""
        if impact.lower() == "high" and ease.lower() == "high":
            risk = "High"
        elif (impact.lower() == "high" and ease.lower() == "moderate") or (impact.lower() == "high" and ease.lower() == "medium"):
            risk = "Moderate"
        elif impact.lower() == "high" and ease.lower() == "low":
            risk = "Moderate"
        elif (impact.lower() == "moderate" and ease.lower() == "high") or (impact.lower() == "moderate" and ease.lower() == "moderate") or (impact.lower() == "moderate" and ease.lower() == "medium"):
            risk = "Moderate"
        elif impact.lower() == "moderate" and ease.lower() == "low":
            risk = "Low"
        elif impact.lower() == "low" and ease.lower() == "high":
            risk = "Moderate"
        elif (impact.lower() == "low" and ease.lower() == "moderate") or (impact.lower() == "low" and ease.lower() == "low"):
            risk = "Low"
        return risk

    def appendCweNum(self, newCveSite):
        cweNum = ''
        pattern1 = re.compile(r'CWE-[0-9][0-9]')
        pattern2 = re.compile(r'CWE-[0-9][0-9][0-9]')
        pattern3 = re.compile(r'CWE-[0-9][0-9][0-9][0-9]')
        # Getting CWE ID from cvedetails website via generic HTTP GET request
        cweReq = requests.get(newCveSite)

        # Converting response body into a string
        responseBody = str(cweReq.text)

        # Searching response body (string version) to see if it has a two, three, or four digit CWE number
        # No CVEs are associated with a one digit CWE number on cvedetails so it is currently excluded
        match1 = re.search(pattern1, responseBody)
        match2 = re.search(pattern2, responseBody)
        match3 = re.search(pattern3, responseBody)
        if match1:
            s = match1.start()
            e = match1.end()
            cweNum = match1.string[s:e]
        elif match2:
            s = match2.start()
            e = match2.end()
            cweNum = match2.string[s:e]
        elif match3:
            s = match3.start()
            e = match3.end()
            cweNum = match3.string[s:e]
        else:
            cweNum = ""

        return cweNum

    def refCveAlreadyExists(self, issuetitle, cvePattern1, cvePattern2, cvePattern3, field):
        issue_title = issuetitle
        cveNum = ''
        cveList = []
        cveMatch1 = re.findall(cvePattern1, field)  # If the CVE number is in this format: CVE-xxxx-xxxx
        cveMatch2 = re.findall(cvePattern2, field)  # If the CVE number is in this format: CVE-xxxx-xxxxx
        cveMatch3 = re.findall(cvePattern3, field)  # If the CVE number is in this format: CVE-xxxx-xxxxxx
        if cveMatch1:
            print("\nFound at least one CVE number in References section of " + issue_title)
            for item in cveMatch1:
                cveList.append(item)
        elif cveMatch2:
            for item in cveMatch2:
                cveList.append(item)
        elif cveMatch3:
            for item in cveMatch3:
                cveList.append(item)
        else:
            print("\nFound no CVE numbers in References section of " + issue_title)

        return cveList

    def refUrlAlreadyExists(self, issuetitle, cvePattern1, cvePattern2, cvePattern3, field):
        newCveSite = 'https://cvedetails.com/cve/'
        issue_title = issuetitle
        cveDetailsMatch1 = re.findall(cvePattern1, field)
        cveDetailsMatch2 = re.findall(cvePattern2, field)
        cveDetailsMatch3 = re.findall(cvePattern3, field)
        cveSiteList = []
        if cveDetailsMatch1:
            print("\nFound a quad digit cvedetails link in References section of issue " + issue_title)
            for item in cveDetailsMatch1:
                cveSiteList.append(newCveSite + item)
        elif cveDetailsMatch2:
            print("\nFound a five digit cvedetails link in References section of issue " + issue_title)
            for item in cveDetailsMatch2:
                cveSiteList.append(newCveSite + item)
        elif cveDetailsMatch3:
            print("\nFound a six digit cvedetails link in References section of issue " + issue_title)
            for item in cveDetailsMatch3:
                cveSiteList.append(newCveSite + item)
        else:
            print("\nFound no cvedetails links in References section of " + issue_title)

        return cveSiteList

    def cvedetailsUrl(self, issuetitle, cveList, cvePattern1, cvePattern2, cvePattern3, field):  # This is called if a CVE number is found but no cvedetails link
        newCveSite = 'https://cvedetails.com/cve/'
        issue_title = issuetitle
        cveSiteList = []
        for item in cveList:
            cveSiteList.append(newCveSite + item)

        return cveSiteList

    def appendCveNum(self):
        # Add CVE number to the CVE_ID and References field of every issue in Dradis
        today = str(datetime.today())
        newCveSite = 'https://cvedetails.com/cve/'
        cvePattern1 = re.compile(r'CVE-[0-9][0-9][0-9][0-9]-[0-9][0-9][0-9][0-9]')
        cvePattern2 = re.compile(r'CVE-[0-9][0-9][0-9][0-9]-[0-9][0-9][0-9][0-9][0-9]')
        cvePattern3 = re.compile(r'CVE-[0-9][0-9][0-9][0-9]-[0-9][0-9][0-9][0-9][0-9][0-9]')
        refPattern = re.compile(r'References')
        cvePattern = re.compile(r'CVE_ID')
        cwePattern = re.compile(r'CWE_ID')
        pattern1 = re.compile(r'CWE-[0-9][0-9]')
        pattern2 = re.compile(r'CWE-[0-9][0-9][0-9]')
        pattern3 = re.compile(r'CWE-[0-9][0-9][0-9][0-9]')
        modulePattern = re.compile(r'Module_OTGv4')
        touchedByPattern = re.compile(r'Touched_By')
        cvssPattern1 = re.compile(r'[0-9].[0-9]')
        cvssPattern2 = re.compile(r'[0-1][0-9].[0-9]')
        # HTTP GET request headers
        headers = {'Authorization': 'Token token={0}'.format(self.dradis_api_token), 'Dradis-Project-Id': self.dradis_project_id}

		# HTTP PUT request headers
        putHeaders = {'Authorization': 'Token token={0}'.format(self.dradis_api_token), 'Dradis-Project-Id': self.dradis_project_id, 'Content-Type':'application/json'}

        # HTTP GET request to get all issues in the specified Dradis project
        response = self.session.get(self.dradis_issues_url, headers=headers, verify=self.verify_cert)

        # If the above GET request returns 200 code, let the user know, otherwise say what's wrong
        if '[200]' in str(response):
            print('HTTP 200 OK')
        else:
            print('Did not receive HTTP 200 code, probably incorrect Dradis url argument. ' + str(response))
        
        # Convert the GET response into a JSON object which will be interpreted by Python as a dict, lovely
        issues = response.json()
        
        # Print the response body (all issues in Dradis) to show that it works (hopefully)
        #print(issues)

        # Loop over every primary issue (highest level JSON object) in the dict containing all Dradis issues
        for issue in issues:
            # Loop over every field and value within each Dradis issue
            issueTitle = ''
            issueImpact = ''
            issueEase = ''
            issueRisk = ''
            issueConfidentiality = ''
            issueIntegrity = ''
            issueAvaiability = ''
            issueCvss = ''
            issueSummary = ''
            issueInsight = ''
            issueMitigation = ''
            issueRiskStatus = ''
            issueThreatAgent = ''
            issueGainedAccess = ''
            issueVulnType = ''
            issueTouchedBy = ''
            issueCveId = ''
            issueCweId = ''
            issueModules = ''
            impact = ''
            confidentiality = ''
            integrity = ''
            authentication = ''
            threatAgent = ''
            gainedAccess = ''
            vulnType = ''
            impactList = []
            ease = ''
            easeList = []
            risk = ''
            cveNum = ''
            cweNum = ''
            cweList = []
            cvss = ''
            cvssExists = False  # Does the issue already have a CVSS score?
            cweField = '\r\n#[CWE_ID]#\r\n'
            cveField = '\r\n#[CVE_ID]#\r\n'
            cveFieldExists = False  # Does the CVE_ID issue field exist in the issue?
            cweFieldExists = False  # Does the CWE_ID issue field exist in the issue?
            cveExists = False  # Is there a CVE number in the References section?
            cweExists = False  # Is there a CWE ID?
            refExists = False  # Is there already a cvedetails website in References?
            refContainer = ''
            issueText = ''
            frankenstein = ''
            cveList = []
            cveSiteList = []
            endOfIssue = 0
            realEndOfIssue = 0
            for key, value in issue.items():
                # Code to find issue ID, which is used to identify the issue and is used in the PUT URL, very important
                if key == 'id':
                    issue_id = str(issue[key])
                    dradis_issue_url = self.dradis_issues_url + '/' + issue_id

                # Storing current issue title, for debugging
                if key == 'title':
                    issue_title = str(issue[key])
                    issueTitle = "#[Title]#\r\n" + issue_title + "\r\n\r\n"
                #print('KEY: ' + str(key) + ' VALUE: ' + str(value))  # Listing every issue field and value just to show that it is working

                # Appending the entirety of the current issue into a string variable
                if key == 'text':
                    issueText = str(issue[key])
                    realEndOfIssue = len(issueText)
                    myEnd = re.search(modulePattern, issue[key])
                    touchMe = re.search(touchedByPattern, issue[key])
                    if not touchMe:
                        if myEnd:
                            x = myEnd.start() - 2
                            y = myEnd.end() + 2
                            endOfIssue = len(issueText) - x
                            issueModules = myEnd.string[x:]
                        else:
                            issueModules = "#[Module_OTGv4]#\r\n\r\n#[Module_PCIDSS32]#\r\n\r\n#[Module_HIPAA]#\r\n\r\n#[Module_NIST53]#\r\n\r\n#[Module_ISO27K2013]#\r\n\r\n#[Module_GDPR2016]#\r\n\r\n#[Touched_By]#\r\nCVE_Bot_" + today + "\r\n\r\n"
                    else:
                        a = touchMe.start() - 2
                        b = touchMe.end() + 2
                        if myEnd:
                            y = myEnd.start() - 2
                            z = myEnd.end() + 2
                            issueModules = myEnd.string[y:z]
                        else:
                            issueModules = "#[Module_OTGv4]#\r\n\r\n#[Module_PCIDSS32]#\r\n\r\n#[Module_HIPAA]#\r\n\r\n#[Module_NIST53]#\r\n\r\n#[Module_ISO27K2013]#\r\n\r\n#[Module_GDPR2016]#\r\n\r\n"

                # 'Fields' is a JSON parameter that contains its own JSON parameters, so it is its own dict. Loop over it to dig inside each issue.
                if key == 'fields':
                    fields = value
                    #print('\nFIELDS: ' + str(fields) + '\n\n')  # Debug output
                    # Operation to carry out if CVE_ID and CWE_ID fields do not exist
                    if 'CVE_ID' not in fields.keys() and 'CWE_ID' not in fields.keys():
                        # Looping over every key and value of the fields dict
                        for cey, falue in fields.items():
                            #print('CEY: ' + str(cey) + ' FALUE: ' + str(falue) + '\n\n')  # Debug output
                            if cey == 'Impact':
                                issueImpact = "#[Impact]#\r\n" + fields[cey] + "\r\n\r\n"
                                impact = fields[cey]

                            if cey == 'Ease':
                                issueEase = "#[Ease]#\r\n" + fields[cey] + "\r\n\r\n"
                                ease = fields[cey]

                            if cey == 'Confidentiality_Impact':
                                issueConfidentiality = "#[Confidentiality_Impact]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Integrity_Impact':
                                issueIntegrity = "#[Integrity_Impact]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Availability_Impact':
                                issueAvailability = "#[Availability_Impact]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Risk':
                                issueRisk = "#[Risk]#\r\n" + fields[cey] + "\r\n\r\n"
                                risk = fields[cey]
                                if "high" not in fields[cey].lower() and "moderate" not in fields[cey].lower() and "medium" not in fields[cey].lower() and "low" not in fields[cey].lower():
                                    issueRisk = "#[Risk]#\r\n" + self.calculateRisk(impact, ease) + "\r\n\r\n"

                            if cey == 'Authentication':
                                issueAuthentication = "#[Authentication]#\r\n" + fields[cey] + "\r\n\r\n"

                            # Getting CVSS score, will check to see if it's already in the issue first
                            if cey == 'CVSS':
                                issueCvss = "#[CVSS]#\r\n" + fields[cey] + "\r\n\r\n"
                                cvssMatch1 = re.search(cvssPattern1, issueCvss)
                                cvssMatch2 = re.search(cvssPattern2, issueCvss)
                                if cvssMatch1:
                                    cvssExists = True
                                    s = cvssMatch1.start()
                                    e = cvssMatch1.end()
                                    cvss = cvssMatch1.string[s:e]
                                elif cvssMatch2:
                                    cvssExists = True
                                    s = cvssMatch2.start()
                                    e = cvssMatch2.end()
                                    cvss = cvssMatch2.string[s:e]
                                else:
                                    cvss = self.appendCvss(newCveSite, issue_title)
                                    issueCvss = "#[CVSS]#\r\n" + cvss
                                    cvssTestMatch1 = re.search(cvssPattern1, cvss)
                                    cvssTestMatch2 = re.search(cvssPattern2, cvss)
                                    if cvssTestMatch1 or cvssTestMatch2:
                                        cvssExists = True
                                    else:
                                        cvssExists = False
                                        print("\nNo CVSS score found in " + issue_title)

                            if cey == 'Summary':
                                issueSummary = "#[Summary]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Insight':
                                issueInsight = "#[Insight]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Mitigation':
                                issueMitigation = "#[Mitigation]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Risk_Status':
                                issueRiskStatus = "#[Risk_Status]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Threat_Agent':
                                issueThreatAgent = "#[Threat_Agent]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Gained_Access':
                                issueGainedAccess = "#[Gained_Access]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Vulnerability_Type':
                                issueVulnType = "#[Vulnerability_Type]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'References':
                                issueReferences = "#[References]#\r\n" + fields[cey] + "\r\n\r\n"
                                # If there is already a CVE number in the References issue field, use that
                                if ('CVE-' in issueReferences.upper() or 'cve-' in issueReferences) and 'cvedetails' not in issueReferences.lower():  # Crudely verifying that there is a CVE number in the References field
                                    print("\nFound a CVE ID but no cvedetails link in References section\n")
                                    cveList = self.refCveAlreadyExists(issue_title, cvePattern1, cvePattern2, cvePattern3, issueReferences)
                                    cveSiteList = self.cvedetailsUrl(issue_title, cveList, cvePattern1, cvePattern2, cvePattern3, issueReferences.lower())
                                    cveExists = True
                                    issueReferences = "#[References]#\r\n"
                                    for item in cveSiteList:
                                        issueReferences += item + "\r\n"
                                    issueReferences += fields[cey] + "\r\n\r\n"
                                    issueCveId = "#[CVE_ID]#\r\n"
                                    for item in cveList:
                                        issueCveId += item + "\r\n"
                                    issueCveId += "\r\n"
                                # If a cvedetails website is in the References section already
                                elif 'cvedetails' in issueReferences.lower():
                                    cveSiteList = self.refUrlAlreadyExists(issue_title, cvePattern1, cvePattern2, cvePattern3, issueReferences)
                                    cveExists = True
                                    refExists = True
                                    cveList = self.refCveAlreadyExists(issue_title, cvePattern1, cvePattern2, cvePattern3, issueReferences)
                                    issueCveId = "#[CVE_ID]#\r\n"
                                    for item in cveList:
                                        issueCveId += item + "\r\n"
                                    issueCveId += "\r\n\r\n"
                                else:
                                    print("\nFound no CVE data in References section\n")
                                    issueCveId = "#[CVE_ID]#\r\n\r\n"

                            # Getting CWE ID from cvedetails website via generic HTTP GET request
                            for item in cveSiteList:
                                cweList.append(self.appendCweNum(item))
                            issueCweId = "#[CWE_ID]#\r\n"
                            for item in cweList:
                                issueCweId += item + "\r\n"
                            issueCweId += "\r\n\r\n"

                            if cey == 'Touched_By':
                                issueTouchedBy = "#[Touched_By]#\r\n" + fields[cey] + "\r\nCVE_Bot_" + today + "\r\n\r\n"
                    # Operation to carry out if CVE_ID and/or CWE_ID fields already exist in the issue
                    else:
                        for cey, falue in fields.items():
                            if cey == 'Impact':
                                issueImpact = "#[Impact]#\r\n" + fields[cey] + "\r\n\r\n"
                                impact = fields[cey]

                            if cey == 'Ease':
                                issueEase = "#[Ease]#\r\n" + fields[cey] + "\r\n\r\n"
                                ease = fields[cey]

                            if cey == 'Confidentiality_Impact':
                                issueConfidentiality = "#[Confidentiality_Impact]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Integrity_Impact':
                                issueIntegrity = "#[Integrity_Impact]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Availability_Impact':
                                issueAvailability = "#[Availability_Impact]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Risk':
                                issueRisk = "#[Risk]#\r\n" + fields[cey] + "\r\n\r\n"
                                risk = fields[cey]
                                if "high" not in fields[cey].lower() and "moderate" not in fields[cey].lower() and "medium" not in fields[cey].lower() and "low" not in fields[cey].lower():
                                    issueRisk = "#[Risk]#\r\n" + self.calculateRisk(impact, ease) + "\r\n\r\n"

                            if cey == 'Authentication':
                                issueAuthentication = "#[Authentication]#\r\n" + fields[cey] + "\r\n\r\n"

                            # Getting CVSS score, will check to see if it's already in the issue first
                            if cey == 'CVSS':
                                issueCvss = "#[CVSS]#\r\n" + fields[cey] + "\r\n\r\n"
                                cvssMatch1 = re.search(cvssPattern1, issueCvss)
                                cvssMatch2 = re.search(cvssPattern2, issueCvss)
                                if cvssMatch1:
                                    cvssExists = True
                                    s = cvssMatch1.start()
                                    e = cvssMatch1.end()
                                    cvss = cvssMatch1.string[s:e]
                                    print("\nCVSS score of " + cvss + " found in " + issue_title)
                                elif cvssMatch2:
                                    cvssExists = True
                                    s = cvssMatch2.start()
                                    e = cvssMatch2.end()
                                    cvss = cvssMatch2.string[s:e]
                                    print("\nCVSS score of " + cvss + " found in " + issue_title)
                                else:
                                    cvss = self.appendCvss(newCveSite, issue_title)
                                    cvssTestMatch1 = re.search(cvssPattern1, cvss)
                                    cvssTestMatch2 = re.search(cvssPattern2, cvss)
                                    if cvssTestMatch1 or cvssTestMatch2:
                                        cvssExists = True
                                        print("\nCVSS score of " + cvss + " found in " + issue_title)
                                    else:
                                        cvssExists = False
                                        print("\nNo CVSS score found in " + issue_title)

                            if cey == 'Summary':
                                issueSummary = "#[Summary]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Insight':
                                issueInsight = "#[Insight]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Mitigation':
                                issueMitigation = "#[Mitigation]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Risk_Status':
                                issueRiskStatus = "#[Risk_Status]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Threat_Agent':
                                issueThreatAgent = "#[Threat_Agent]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Gained_Access':
                                issueGainedAccess = "#[Gained_Access]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'Vulnerability_Type':
                                issueVulnType = "#[Vulnerability_Type]#\r\n" + fields[cey] + "\r\n\r\n"

                            if cey == 'References':
                                issueReferences = "#[References]#\r\n" + fields[cey] + "\r\n\r\n"
                                refContainer = fields[cey]
                                # If there is already a CVE number in the References issue field, use that
                                if ('CVE-' in issueReferences.upper() or 'cve-' in issueReferences) and 'cvedetails' not in issueReferences.lower():  # Crudely verifying that there is a CVE number in the References field
                                    print("\nFound a CVE ID but no cvedetails link in References section\n")
                                    cveList = self.refCveAlreadyExists(issue_title, cvePattern1, cvePattern2, cvePattern3, issueReferences)
                                    cveSiteList = self.cvedetailsUrl(issue_title, cveList, cvePattern1, cvePattern2, cvePattern3, issueReferences.lower())
                                    cveExists = True
                                    issueReferences = "#[References]#\r\n"  
                                    for item in cveSiteList:
                                        issueReferences += item + "\r\n"
                                    issueReferences += fields[cey] + "\r\n\r\n"
                                    issueCveId = "#[CVE_ID]#\r\n"
                                    for item in cveList:
                                        issueCveId += item + "\r\n"
                                    issueCveId += "\r\n\r\n"
                                # If a cvedetails website is in the References section already
                                elif 'cvedetails' in issueReferences.lower():
                                    cveSiteList = self.refUrlAlreadyExists(issue_title, cvePattern1, cvePattern2, cvePattern3, issueReferences)
                                    cveExists = True
                                    refExists = True
                                    cveList = self.refCveAlreadyExists(issue_title, cvePattern1, cvePattern2, cvePattern3, issueReferences)
                                    issueCveId = "#[CVE_ID]#\r\n"
                                    for item in cveList:
                                        issueCveId += item + "\r\n"
                                    issueCveId += "\r\n"
                                else:
                                    print("\nFound no CVE data in References section\n")
                                    issueCveId = "#[CVE_ID]#\r\n\r\n"
                            # Checking to see if a CVE_ID field already exists, must edit cveNum to not include Dradis code
                            if cey == 'CVE_ID':
                                cveFieldExists = True
                                if 'CVE-' in fields[cey].upper() or 'cve-' in fields[cey]:  #Crudely verifying that there is a CVE number in the CVE_ID field
                                    issueCveId = "#[CVE_ID]#\r\n" + fields[cey] + "\r\n\r\n"
                                    cveExists = True
                                    cveMatch1 = re.findall(cvePattern1, fields[cey])  # If the CVE number is in this format: CVE-xxxx-xxxx
                                    cveMatch2 = re.findall(cvePattern2, fields[cey])  # If the CVE number is in this format: CVE-xxxx-xxxxx
                                    cveMatch3 = re.findall(cvePattern3, fields[cey])  # If the CVE number is in this format: CVE-xxxx-xxxxxx
                                    if cveMatch1:
                                        for item in cveMatch1:
                                            cveList.append(item)
                                    elif cveMatch2:
                                        for item in cveMatch2:
                                            cveList.append(item)
                                    elif cveMatch3:
                                        for item in cveMatch3:
                                            cveList.append(item)

                                    # If there is no cvedetails link in References section (we already know this by now), make one now
                                    if refExists == False:
                                        issueReferences = "#[References]#\r\n"  
                                        for item in cveList:
                                            issueReferences += newCveSite + item + "\r\n"
                                        issueReferences += refContainer + "\r\n\r\n"
                                else:
                                    print("Found a CVE_ID field with no CVE number in it, in issue #" + issue_id + " " + issue_title + ", skipping...")
                                    cveNum = 'N/A'

                            # Checking to see if a CWE_ID field already exists
                            if cey == 'CWE_ID':
                                cweFieldExists = True
                                if 'CWE-' in fields[cey].upper() or 'cwe-' in fields[cey]:
                                    issueCweId = "#[CWE_ID]#\r\n" + fields[cey] + "\r\n\r\n"
                                    cweMatch1 = re.search(pattern1, fields[cey])
                                    cweMatch2 = re.search(pattern2, fields[cey])
                                    cweMatch3 = re.search(pattern3, fields[cey])
                                    if cweMatch1:
                                        cweExists = True
                                        s = cweMatch1.start()
                                        e = cweMatch1.end()
                                        cweNum = cweMatch1.string[s:e]
                                        cweList.append(cweNum)
                                    elif cweMatch2:
                                        cweExists = True
                                        s = cweMatch2.start()
                                        e = cweMatch2.end()
                                        cweNum = cweMatch2.string[s:e]
                                        cweList.append(cweNum)
                                    elif cweMatch3:
                                        cweExists = True
                                        s = cweMatch3.start()
                                        e = cweMatch3.end()
                                        cweNum = cweMatch3.string[s:e]
                                        cweList.append(cweNum)
                                else:
                                    cweExists = True
                                    for item in cveSiteList:
                                        cweList.append(self.appendCweNum(item))
                                    issueCweId = "#[CWE_ID]#\r\n" 
                                    for item in cweList:
                                        issueCweId += item + "\r\n"
                                    issueCweId += "\r\n\r\n"

                            if cey == 'Touched_By':
                                issueTouchedBy = "#[Touched_By]#\r\n" + fields[cey] + "\r\nCVE_Bot_" + today + "\r\n\r\n"

            if "high" not in impact.lower() and "moderate" not in impact.lower() and "medium" not in impact.lower() and "low" not in impact.lower():
                issueImpact = "#[Impact]#\r\n"
                for item in cveSiteList:
                    impactList += self.appendImpact(item, issue_title)
                if "high" in impactList or "High" in impactList:
                    impact = "High"
                elif "moderate" in impactList or "Moderate" in impactList or "medium" in impactList or "Medium" in impactList:
                    impact = "Moderate"
                elif "low" in impactList or "Low" in impactList:
                    impact = "Low"
                else:
                    impact = "Low"
                issueImpact += impact + "\r\n\r\n"

            if "high" not in ease.lower() and "moderate" not in ease.lower() and "medium" not in ease.lower() and "low" not in ease.lower():
                issueEase = "#[Ease]#\r\n"
                for item in cveSiteList:
                    easeList += self.appendComplexity(item, issue_title)
                if "high" in easeList or "High" in easeList:
                    ease = "High"
                elif "moderate" in easeList or "Moderate" in easeList or "medium" in easeList or "Medium" in easeList:
                    ease = "Moderate"
                elif "low" in easeList or "Low" in easeList:
                    ease = "Low"
                else:
                    ease = "Low"
                issueEase += ease + "\r\n\r\n"

            if "high" in issueImpact.lower():
                impact = "High"
            elif "moderate" in issueImpact.lower():
                impact = "Moderate"
            elif "low" in issueImpact.lower():
                impact = "Low"

            if "high" in issueEase.lower():
                ease = "High"
            elif "moderate" in issueEase.lower():
                ease = "Moderate"
            elif "low" in issueEase.lower():
                ease = "Low"

            if "complete" not in issueConfidentiality.lower() and "partial" not in issueConfidentiality.lower() and "none" not in issueConfidentiality.lower():
                confidentiality = self.appendConfidentiality(newCveSite, issue_title)
                issueConfidentiality = "#[Confidentiality_Impact]#\r\n" +  + "\r\n\r\n"

            if "complete" not in issueIntegrity.lower() and "partial" not in issueIntegrity.lower() and "none" not in issueIntegrity.lower():
                issueIntegrity = "#[Integrity_Impact]#\r\nNone\r\n\r\n"

            if "complete" not in issueAvailability.lower() and "partial" not in issueAvailability.lower() and "none" not in issueAvailability.lower():
                issueIntegrity = "#[Availability_Impact]#\r\nNone\r\n\r\n"

            if "Risk" not in issueRisk:
                issueRisk = "#[Risk]#\r\n\r\n"

            if "high" not in risk.lower() and "moderate" not in risk.lower() and "medium" not in risk.lower() and "low" not in risk.lower():
                issueRisk = "#[Risk]#\r\n" + self.calculateRisk(impact, ease) + "\r\n\r\n"

            if "required" not in issueAuthentication.lower():
                issueAuthentication = "#[Authentication]#\r\nNot required\r\n\r\n"

            if "cve_bot" not in issueTouchedBy.lower():
                issueTouchedBy = "#[Touched_By]#\r\nCVE_Bot_" + today + "\r\n\r\n"

            frankenstein = issueTitle + issueImpact + issueConfidentiality + issueIntegrity + issueAvailability + issueEase + issueRisk + issueAuthentication + issueCvss + issueSummary + issueInsight + issueMitigation + issueRiskStatus + issueThreatAgent + issueGainedAccess + issueVulnType + issueReferences + issueCveId + issueCweId + issueModules + issueTouchedBy

            # This is the only way to do PUT or POST requests with Dradis API
            issue_data = {'issue': {"text": frankenstein}}

            # The almighty HTTP PUT request to edit issues
            dradis = requests.put(dradis_issue_url, data=dumps(issue_data), headers=putHeaders, verify=self.verify_cert)
            if dradis.status_code == 200:
                print("Successfully added CVE fields to the following issue: " + issue_title)
            else:
                print("Failed adding CVE fields to issue: \n\n{1}\nStatus Code: {2}\n\n".format(dradis.status_code, dradis.text))
        return

    @staticmethod
    def parse_args():
        # parse the arguments
        parser = ArgumentParser(epilog='\tExample: \r\npython ' + argv[0] +
                                       " https://dradis.govanguard.co/ 21 xa632ghas87d393287",
                                description="Automatically add CVE number to all Dradis issues")
        parser.add_argument('dradis_url', help="Dradis URL")
        parser.add_argument('dradis_project_id', help="Dradis Project ID")
        parser.add_argument('dradis_api_token', help="Dradis API token")
        return parser.parse_args()

if __name__ == "__main__":
    c = cveScript()
    c.run()
